---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { allPricingPlans } from '../lib/allPricingPlans';
import { EXTERNAL_EMAILS } from '../lib/external';

const defaultCenterIndex = Math.max(0, allPricingPlans.findIndex((p) => p.name === 'Growth'));
---

<Layout
	title="Pricing - GameLayer"
	description="All pricing tiers (reference). Choose a plan based on programme size."
	noindex={true}
>
	<main id="main-content" class="page">
		<Header />

		<div class="section pricing-page-section">
			<div class="container">
				<div class="pricing-content">
					<div class="pricing-header">
						<h1>Pricing Tiers</h1>
					</div>

					<div class="pricing-carousel-wrapper">
						<div class="pricing-carousel" id="pricing-carousel">
							<div class="pricing-carousel-track">
								{allPricingPlans.map((plan) => (
									<div class="pricing-card">
										<div class="pricing-card-header">
											<h2 class="pricing-title">{plan.name}</h2>
											<div class="pricing-price">
												<span class="price">{plan.price}</span>
												{plan.period && <span class="period">{plan.period}</span>}
											</div>
										</div>

										<div class="pricing-features">
											<ul>
												{plan.features.map((feature) => {
													const isSupport = feature.startsWith('Technical & Implementation Support:');
													const isConceptualSupport = feature.startsWith('Concept & Programme Design Support:');
													const isAnalytics = feature.startsWith('Analytics & Reporting:');
													const isActiveUsers = feature.includes('active users');
													return (
														<li class={`feature-item ${isActiveUsers ? '' : 'feature-item-meta'}`}>
															{!isActiveUsers && <span class="bullet-point">•</span>}
															<span class="feature-text">
																{isSupport ? (
																	<>
																		<strong>Technical & Implementation Support:</strong> {feature.replace('Technical & Implementation Support:', '').trim()}
																	</>
																) : isConceptualSupport ? (
																	<>
																		<strong>Concept & Programme Design Support:</strong> {feature.replace('Concept & Programme Design Support:', '').trim()}
																	</>
																) : isAnalytics ? (
																	<>
																		<strong>Analytics & Reporting:</strong> {feature.replace('Analytics & Reporting:', '').trim()}
																	</>
																) : isActiveUsers ? (
																	<>
																		Up to <strong>{feature.replace('Up to ', '').trim()}</strong>
																	</>
																) : (
																	feature
																)}
															</span>
														</li>
													);
												})}
											</ul>
										</div>
									</div>
								))}
							</div>
						</div>
					</div>

					<div class="carousel-pagination" id="carousel-pagination">
						<div class="carousel-dots" role="tablist" aria-label="Pricing plan">
							{allPricingPlans.map((_, i) => (
								<button type="button" class="carousel-dot" data-index={i} aria-label={`Plan ${i + 1}`} aria-selected={i === defaultCenterIndex}></button>
							))}
						</div>
					</div>

					<div class="pricing-cta-wrapper">
						<a
							href={`mailto:${EXTERNAL_EMAILS.SALES}?subject=GameLayer%20Pricing%20Enquiry`}
							target="_self"
							class="button button-primary pricing-cta-button"
						>
							Contact us
						</a>
					</div>

					<div class="pricing-footnote">Free plan available for testing — up to 100 users</div>
				</div>
			</div>
		</div>

		<Footer />
	</main>
</Layout>

<style>
	.pricing-page-section {
		padding-top: 2rem;
		padding-bottom: 4rem;
	}

	.pricing-content {
		width: 100%;
		max-width: 1400px;
		margin: 0 auto;
	}

	.pricing-header {
		max-width: 720px;
		margin: 0 auto 2rem;
		text-align: center;
	}

	.pricing-header h1 {
		font-size: var(--gl-h2-size, 2rem);
		font-weight: var(--gl-h2-weight, 700);
		line-height: 1.2;
		letter-spacing: -0.02em;
		margin: 0 0 0.5rem;
		color: var(--as-black, #0f172a);
	}

	.pricing-header p {
		font-size: var(--gl-lede-size, 1.125rem);
		color: var(--gl-lede-color, rgba(15, 23, 42, 0.8));
		margin: 0;
	}

	.pricing-carousel-wrapper {
		max-width: 1200px;
		margin-left: auto;
		margin-right: auto;
		margin-bottom: 2rem;
	}

	.pricing-carousel {
		width: 100%;
		min-width: 0;
		overflow: hidden;
	}

	.pricing-carousel-track {
		display: flex;
		gap: 18px;
		overflow-x: auto;
		scroll-snap-type: x mandatory;
		scroll-behavior: smooth;
		-webkit-overflow-scrolling: touch;
		padding: 4px 0;
		scrollbar-width: none;
		-ms-overflow-style: none;
	}

	.pricing-carousel-track::-webkit-scrollbar {
		display: none;
	}

	.carousel-pagination {
		display: flex;
		align-items: center;
		justify-content: center;
		margin-top: 0.5rem;
		margin-bottom: 2rem;
		flex-wrap: wrap;
	}

	.pricing-card {
		/* 3.5 cards visible: (container - 3 gaps) / 3.5; cap at ~328px for max-width 1200px */
		flex: 0 0 min(328px, calc((100vw - 3 * 18px) / 3.5));
		scroll-snap-align: start;
		scroll-snap-stop: always;
		background: #fff;
		border: 1px solid rgba(15, 23, 42, 0.1);
		border-radius: 22px;
		box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
		padding: 32px;
		display: flex;
		flex-direction: column;
		min-height: 320px;
		transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
		box-sizing: border-box;
	}

	.pricing-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 14px 40px rgba(15, 23, 42, 0.08);
		border-color: rgba(15, 23, 42, 0.12);
	}

	.pricing-card-header {
		text-align: center;
		margin-bottom: var(--gl-card-content-gap, 1rem);
	}

	.pricing-title {
		margin: 0 0 0.5rem;
		font-size: var(--gl-h3-size, 1.35rem);
		font-weight: var(--gl-h3-weight, 600);
		line-height: 1.1;
		color: var(--color-text, #0f172a);
	}

	.pricing-price {
		margin: 0;
		text-align: center;
		display: flex;
		align-items: baseline;
		justify-content: center;
		gap: 6px;
	}

	.price {
		font-size: 2rem;
		font-weight: 900;
		letter-spacing: -0.02em;
		color: var(--color-text, #0f172a);
		line-height: 1;
	}

	.period {
		font-size: 13px;
		opacity: 0.7;
		color: var(--color-text, #0f172a);
	}

	.pricing-features {
		flex-grow: 1;
		margin: 0;
		margin-top: 1rem;
	}

	.pricing-features ul {
		list-style: none;
		padding: 0;
		margin: 0;
		display: grid;
		gap: 0.5rem;
		color: rgba(15, 23, 42, 0.86);
	}

	.feature-item {
		display: flex;
		align-items: flex-start;
		gap: 0.5rem;
		line-height: 1.5;
		font-size: 14px;
		font-weight: 400;
	}

	.feature-item-meta {
		font-size: 12px;
		font-style: italic;
		color: #9ca3af;
	}

	.feature-text {
		flex: 1;
	}

	.bullet-point {
		margin-top: 2px;
		flex-shrink: 0;
		color: rgba(15, 23, 42, 0.86);
		font-size: 14px;
	}

	.pricing-note {
		margin: 0 auto 1.5rem;
		text-align: center;
		font-size: 15px;
		color: rgba(15, 23, 42, 0.65);
		max-width: 720px;
	}

	.pricing-cta-wrapper {
		display: flex;
		justify-content: center;
		margin-bottom: 1rem;
	}

	.pricing-cta-button {
		min-width: 160px;
	}

	.pricing-footnote {
		text-align: center;
		font-size: 15px;
		font-style: italic;
		color: rgba(15, 23, 42, 0.65);
	}

	.carousel-dots {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 10px;
		flex-wrap: wrap;
	}

	.carousel-dot {
		width: 8px;
		height: 8px;
		border-radius: 50%;
		border: none;
		background: rgba(15, 23, 42, 0.18);
		cursor: pointer;
		transition: width 200ms ease, background 200ms ease, border-radius 200ms ease;
		padding: 0;
	}

	.carousel-dot:hover {
		background: rgba(15, 23, 42, 0.35);
	}

	.carousel-dot[aria-selected="true"] {
		width: 24px;
		border-radius: 999px;
		background: var(--as-accent, #2563eb);
	}

	@media (max-width: 768px) {
		/* ~2.2 cards on tablet */
		.pricing-card {
			flex: 0 0 min(280px, calc((100vw - 18px) / 2.2));
		}
	}

	@media (max-width: 640px) {
		.pricing-card {
			flex: 0 0 85%;
			padding: 22px;
		}

		.pricing-title {
			font-size: 1.25rem;
		}

		.price {
			font-size: 1.75rem;
		}
	}
</style>

<script>
	const carousel = document.getElementById('pricing-carousel');
	const track = carousel?.querySelector('.pricing-carousel-track');
	const dots = document.querySelectorAll('.carousel-dot');

	const defaultCenterIndex = document.querySelector('.carousel-dot[aria-selected="true"]')?.getAttribute('data-index');
	const centerIndex = defaultCenterIndex != null ? parseInt(defaultCenterIndex, 10) : 0;

	function goToIndex(index: number) {
		if (!track) return;
		const cards = track.querySelectorAll('.pricing-card');
		const card = cards[index] as HTMLElement;
		if (card) {
			const left = card.offsetLeft - track.offsetLeft;
			track.scrollTo({ left, behavior: 'smooth' });
		}
		dots.forEach((d, i) => d.setAttribute('aria-selected', String(i === index)));
	}

	function centerCard(index: number) {
		if (!track) return;
		const cards = track.querySelectorAll('.pricing-card');
		const card = cards[index] as HTMLElement;
		if (card) {
			const scrollLeft = card.offsetLeft - track.offsetLeft - (track.clientWidth / 2) + (card.offsetWidth / 2);
			track.scrollTo({ left: Math.max(0, scrollLeft), behavior: 'auto' });
		}
	}

	dots?.forEach((dot, index) => {
		dot.addEventListener('click', () => goToIndex(index));
	});

	if (track) {
		// Centre default card (Growth) on load
		requestAnimationFrame(() => {
			centerCard(centerIndex);
		});

		track.addEventListener('scroll', () => {
			const cards = track.querySelectorAll('.pricing-card');
			const scrollLeft = track.scrollLeft;
			let active = 0;
			for (let i = 0; i < cards.length; i++) {
				const card = cards[i] as HTMLElement;
				if (card.offsetLeft - track.offsetLeft <= scrollLeft + track.clientWidth / 2) {
					active = i;
				}
			}
			dots?.forEach((d, i) => d.setAttribute('aria-selected', String(i === active)));
		});
	}
</script>
