---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getPostBySlug, blogPosts } from '../../data/blogPosts';
import { EXTERNAL_URLS } from '../../lib/external';

export async function getStaticPaths() {
	return blogPosts.map((post) => ({
		params: { slug: post.slug },
	}));
}

const { slug } = Astro.params;

if (!slug) {
	return Astro.redirect('/blog');
}

const blogPost = getPostBySlug(slug);

if (!blogPost) {
	return Astro.redirect('/blog');
}

const formatDate = (dateString: string) => {
	const date = new Date(dateString);
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};

// SEO metadata
const pageTitle = blogPost.ogTitle || blogPost.title;
const pageDescription = blogPost.metaDescription || blogPost.excerpt;
const pageKeywords = blogPost.keywords || 'gamification, user engagement, customer loyalty, gamification API, gamification strategies';

// JSON-LD structured data for SEO
const postUrl = "https://gamelayer.io/blog/" + blogPost.slug;
const blogPostSchema = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	"headline": blogPost.title,
	"datePublished": blogPost.date,
	"description": pageDescription,
	"author": {
		"@type": "Organization",
		"name": "GameLayer"
	},
	"publisher": {
		"@type": "Organization",
		"name": "GameLayer",
		"url": "https://gamelayer.io",
		"logo": {
			"@type": "ImageObject",
			"url": "https://gamelayer.io/logo.png"
		}
	},
	"mainEntityOfPage": {
		"@type": "WebPage",
		"@id": postUrl
	}
};
---

<Layout 
	title={`${blogPost.title} | GameLayer Blog`}
	description={pageDescription}
	keywords={pageKeywords}
	ogTitle={blogPost.ogTitle ? `${blogPost.ogTitle} | GameLayer Blog` : undefined}
	ogDescription={blogPost.ogDescription || pageDescription}
>
	<main id="main-content">
		<Header />
		
		<article class="blog-post">
			<div class="container">
				<div class="blog-post-header text-center max-w-lg m-auto">
					<div class="blog-post-meta">
						<span class="blog-category">{blogPost.category}</span>
						<span class="blog-date">{formatDate(blogPost.date)}</span>
						<span class="blog-read-time">{blogPost.readTime}</span>
					</div>
					<h1 class="blog-post-title">{blogPost.title}</h1>
					<p class="blog-post-excerpt">{blogPost.excerpt}</p>
					{blogPost.slug === 'a-simple-way-to-see-gamification-mechanics-in-action' && (
						<div class="blog-post-featured-image">
							<img src="/images/blog/gamelayer-assets-demo.png" alt="GameLayer Assets — visual gamification mechanics powered by a live API" />
						</div>
					)}
				</div>

				<div class="blog-post-content max-w-lg m-auto">
					<div class="blog-post-body" set:html={blogPost.content}></div>
					
					<div class="blog-post-cta">
						<div class="cta-box">
							<h2>{blogPost.ctaHeading || 'Want to add XP, challenges, and leaderboards to your app without building it from scratch?'}</h2>
							<p set:html={blogPost.ctaDescription ? blogPost.ctaDescription.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') : 'Start using the <strong>GameLayer Gamification API</strong> today.'}></p>
							<a href={EXTERNAL_URLS.CMS_DASHBOARD} target="_blank" rel="noopener noreferrer external" class="button button-primary" aria-label="Open GameLayer dashboard (external)">Sign up free</a>
						</div>
					</div>
				</div>

				<div class="blog-post-navigation max-w-lg m-auto">
					<a href="/blog" class="back-to-blog">
						← Back to Blog
					</a>
				</div>
			</div>
		</article>

		<Footer />
	</main>

	<!-- Blog Post Structured Data for SEO -->
	<script type="application/ld+json" is:inline set:html={JSON.stringify(blogPostSchema)}></script>
	
	<!-- Add class to section heading paragraphs for styling -->
	<script is:inline>
		(function() {
			function addSectionHeadingClasses() {
				const blogBody = document.querySelector('.blog-post-body');
				if (!blogBody) {
					setTimeout(addSectionHeadingClasses, 100);
					return;
				}
				
				const paragraphs = blogBody.querySelectorAll('p');
				let found = 0;
				
				paragraphs.forEach(p => {
					// Get all child nodes
					const children = Array.from(p.childNodes);
					
					// Check if paragraph has only one element child and it's a STRONG
					const elementChildren = children.filter(node => node.nodeType === 1);
					const textChildren = children.filter(node => 
						node.nodeType === 3 && node.textContent.trim().length > 0
					);
					
					// If there's exactly one element child (STRONG) and no significant text nodes
					if (elementChildren.length === 1 && 
						elementChildren[0].nodeName === 'STRONG' && 
						textChildren.length === 0) {
						p.classList.add('section-heading');
						found++;
					}
				});
				
				// Debug: log if we found any
				if (found > 0) {
					console.log('Found', found, 'section headings');
					// Force style application
					blogBody.querySelectorAll('p.section-heading strong').forEach(strong => {
						strong.style.color = '#2563EB';
					});
				}
				
				// Apply color to opening statement
				const openingStatement = blogBody.querySelector('p.opening-statement');
				if (openingStatement) {
					openingStatement.style.color = '#2563EB';
				}
			}
			
			// Run immediately if DOM is ready, otherwise wait
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', addSectionHeadingClasses);
			} else {
				addSectionHeadingClasses();
			}
			
			// Also try after delays in case content loads asynchronously
			setTimeout(addSectionHeadingClasses, 100);
			setTimeout(addSectionHeadingClasses, 500);
			setTimeout(addSectionHeadingClasses, 1000);
		})();
	</script>
</Layout>

<style lang="scss">
	// Two-column intro layout - high specificity
	:global(article.blog-post .container .blog-post-content .blog-post-body .blog-intro-columns),
	:global(.blog-post .container .blog-post-content .blog-post-body .blog-intro-columns),
	:global(.blog-post-content .blog-post-body .blog-intro-columns),
	:global(.blog-post-body .blog-intro-columns),
	:global(div.blog-post-body .blog-intro-columns) {
		display: grid !important;
		grid-template-columns: repeat(2, 1fr) !important;
		gap: 3rem;
		margin: 2rem 0;
		align-items: start;
		width: 100%;
		box-sizing: border-box;

		:global(.blog-intro-text) {
			width: 100%;
			min-width: 0;
			box-sizing: border-box;
			
			p {
				margin-bottom: 1.5rem;
				opacity: 0.9;
			}
		}

		:global(.blog-intro-image) {
			width: 100%;
			min-width: 0;
			box-sizing: border-box;
			display: flex;
			align-items: center;
			justify-content: center;
			
			img {
				width: 25%;
				max-width: 25%;
				height: auto;
				display: block;
				border-radius: 8px;
				box-sizing: border-box;
				object-fit: contain;
			}
		}

		// Tablet portrait and below - stack columns
		@media (max-width: 768px) {
			grid-template-columns: 1fr !important;
			gap: 2rem;

			:global(.blog-intro-image) {
				img {
					width: 25%;
					max-width: 25%;
				}
			}
		}
	}

	// Maximum specificity selectors for blog post headings - must come first
	:global(article.blog-post .container .blog-post-content .blog-post-body h2),
	:global(article.blog-post .blog-post-content .blog-post-body h2),
	:global(.blog-post .container .blog-post-content .blog-post-body h2),
	:global(.blog-post .blog-post-content .blog-post-body h2),
	:global(.container .blog-post-content .blog-post-body h2),
	:global(.blog-post-content .blog-post-body h2),
	:global(.blog-post-body h2),
	:global(div.blog-post-body h2) {
		font-size: 1.8rem !important;
		font-weight: 500 !important;
		color: var(--as-accent) !important;
		margin-top: 3rem !important;
		margin-bottom: 1.5rem !important;
		line-height: 1.8 !important;
	}

	:global(article.blog-post .container .blog-post-content .blog-post-body h3),
	:global(article.blog-post .blog-post-content .blog-post-body h3),
	:global(.blog-post .container .blog-post-content .blog-post-body h3),
	:global(.blog-post .blog-post-content .blog-post-body h3),
	:global(.container .blog-post-content .blog-post-body h3),
	:global(.blog-post-content .blog-post-body h3),
	:global(.blog-post-body h3),
	:global(div.blog-post-body h3) {
		font-size: 1.7rem !important;
		font-weight: 500 !important;
		color: var(--as-accent) !important;
		margin-top: 3rem !important;
		margin-bottom: 1.5rem !important;
		line-height: 1.8 !important;
	}

	main {
		background-color: #fff;
	}

	.blog-post {
		padding: 80px 0;
		background-color: #fff;

		.blog-post-header {
			margin-bottom: 4rem;

			.blog-post-meta {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 1.5rem;
				margin-bottom: 2rem;
				flex-wrap: wrap;
			}

			.blog-category {
				background-color: var(--as-plum);
				color: var(--as-accent);
				padding: 0.4rem 1rem;
				border-radius: 20px;
				font-size: 1.2rem;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.blog-date,
			.blog-read-time {
				color: var(--as-black);
				opacity: 0.6;
				font-size: 1.2rem;
			}

			.blog-post-title {
				font-size: 4rem;
				font-weight: 600;
				color: var(--as-black);
				margin-bottom: 2rem;
				line-height: 1.2;
			}

			.blog-post-excerpt {
				font-size: 1.8rem;
				line-height: 1.6;
				color: var(--as-black);
				opacity: 0.8;
				margin-bottom: 3rem;
			}

			.blog-post-featured-image {
				width: 100%;
				max-width: 900px;
				height: 400px;
				margin: 3rem auto 0 auto;
				box-sizing: border-box;
				overflow: hidden;
				border-radius: 8px;
				background-color: #f0f0f0;
				display: flex;
				align-items: center;
				justify-content: center;

				img {
					width: 100%;
					height: 100%;
					display: block;
					border-radius: 8px;
					object-fit: cover;
				}
			}
		}

		.blog-post-content {
			margin-bottom: 4rem;

			.blog-post-body {
				font-size: 1.6rem;
				line-height: 1.8;
				color: var(--as-black);
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;


				// Style for regular image paragraphs (if any)
				p:has(img) {
					margin: 2rem 0;
					padding: 0;
					width: 100%;
					max-width: 100%;
					box-sizing: border-box;
					overflow: hidden;
					
					img {
						width: 100%;
						max-width: 100%;
						max-height: 500px;
						height: auto;
						display: block;
						opacity: 0.5;
						border-radius: 8px;
						box-sizing: border-box;
						object-fit: contain;
					}
				}

				p {
					margin-bottom: 1.5rem;
					opacity: 0.9;
				}

				// General strong styling
				strong {
					font-weight: 600;
				}
				
				// Style opening statement
				.blog-post-body p.opening-statement {
					color: var(--as-accent) !important;
					font-weight: 600;
					font-size: 1.8rem;
					margin-bottom: 2rem;
				}
				
				// Style section headings - paragraphs that contain only a strong tag
				// Multiple selectors to ensure we catch them
				.blog-post-body p.section-heading strong,
				.blog-post-body p:has(> strong:only-child) strong,
				.blog-post-body p > strong:only-child,
				// Direct targeting for maximum specificity
				article.blog-post .blog-post-content .blog-post-body p:has(> strong:only-child) strong {
					color: var(--as-accent) !important;
					font-weight: 600;
					font-size: 1.6rem;
				}
				
				.blog-post-body p.section-heading,
				.blog-post-body p:has(> strong:only-child) {
					margin-top: 3rem;
					margin-bottom: 1.5rem;
				}

				a {
					color: var(--as-accent);
					text-decoration: underline;
					transition: opacity 0.3s ease;
					
					&:hover {
						opacity: 0.8;
					}
				}

				ul, ol {
					margin-bottom: 1.5rem;
					padding-left: 2rem;

					li {
						margin-bottom: 0.8rem;
						opacity: 0.9;
					}
				}
			}

			.blog-post-cta {
				margin-top: 4rem;
				padding-top: 4rem;
				border-top: 2px solid var(--as-peach);

				.cta-box {
					background-color: var(--as-peach);
					padding: 3rem;
					border-radius: 12px;
					text-align: center;

					h2 {
						font-size: 2.8rem;
						font-weight: 600;
						color: var(--as-black);
						margin-bottom: 1.5rem;
					}

					p {
						font-size: 1.6rem;
						line-height: 1.6;
						color: var(--as-black);
						opacity: 0.8;
						margin-bottom: 2rem;
					}

					.button {
						font-size: 1.5rem;
						padding: 1rem 3rem;
						height: auto;
						line-height: normal;
					}
				}
			}
		}

		.blog-post-navigation {
			padding-top: 3rem;
			border-top: 1px solid #e5e5e5;

			.back-to-blog {
				display: inline-flex;
				align-items: center;
				color: var(--as-accent);
				font-size: 1.6rem;
				font-weight: 600;
				text-decoration: none;
				transition: all 0.3s ease;

				&:hover {
					opacity: 0.8;
					transform: translateX(-5px);
				}
			}
		}

		// Tablet landscape (1024px and below)
		@media (max-width: 1024px) {
			.blog-post-header {
				.blog-post-title {
					font-size: 3.5rem;
				}
			}

			.blog-post-content {
				.blog-post-body {
					h2 {
						font-size: 1.6rem !important;
						color: var(--as-accent) !important;
						line-height: 1.8 !important;
					}

					h3 {
						font-size: 1.5rem !important;
						color: var(--as-accent) !important;
						line-height: 1.8 !important;
					}
				}
			}
		}

		// Tablet portrait (768px and below)
		@media (max-width: 768px) {
			padding: 60px 0;

			.blog-post-header {
				margin-bottom: 3rem;

				.blog-post-title {
					font-size: 3rem;
				}

				.blog-post-excerpt {
					font-size: 1.6rem;
				}
			}

			.blog-post-content {
				margin-bottom: 3rem;

				.blog-post-body {
					font-size: 1.5rem;

					h2 {
						font-size: 1.5rem !important;
						color: var(--as-accent) !important;
						margin-top: 3rem !important;
						line-height: 1.8 !important;
					}

					h3 {
						font-size: 1.5rem !important;
						color: var(--as-accent) !important;
						margin-top: 3rem !important;
						line-height: 1.8 !important;
					}
				}

				.blog-post-cta {
					margin-top: 3rem;
					padding-top: 3rem;

					.cta-box {
						padding: 2.5rem;

						h2 {
							font-size: 2.4rem;
						}

						p {
							font-size: 1.5rem;
						}
					}
				}
			}
		}

		// Mobile landscape (640px and below)
		@media (max-width: 640px) {
			padding: 50px 0;

			.blog-post-header {
				.blog-post-meta {
					flex-direction: column;
					gap: 1rem;
				}

				.blog-post-title {
					font-size: 2.5rem;
				}

				.blog-post-excerpt {
					font-size: 1.5rem;
				}
			}

			.blog-post-content {
				.blog-post-body {
					font-size: 1.4rem;

					h2 {
						font-size: 1.4rem !important;
						color: var(--as-accent) !important;
						line-height: 1.8 !important;
					}

					h3 {
						font-size: 1.4rem !important;
						color: var(--as-accent) !important;
						line-height: 1.8 !important;
					}
				}
			}

			.blog-post-cta {
				.cta-box {
					padding: 2rem;

					h2 {
						font-size: 2rem;
					}

					p {
						font-size: 1.4rem;
					}
				}
			}
		}

		// Mobile portrait (480px and below)
		@media (max-width: 480px) {
			padding: 40px 0;

			.blog-post-header {
				.blog-post-title {
					font-size: 2.2rem;
				}

				.blog-post-excerpt {
					font-size: 1.4rem;
				}

				.blog-category {
					font-size: 1.1rem;
					padding: 0.3rem 0.8rem;
				}

				.blog-date,
				.blog-read-time {
					font-size: 1.1rem;
				}
			}

			.blog-post-content {
				.blog-post-body {
					font-size: 1.3rem;

					h2 {
						font-size: 1.3rem !important;
						color: var(--as-accent) !important;
						line-height: 1.8 !important;
					}

					h3 {
						font-size: 1.3rem !important;
						color: var(--as-accent) !important;
						line-height: 1.8 !important;
					}
				}
			}

			.blog-post-cta {
				.cta-box {
					padding: 1.5rem;

					h2 {
						font-size: 1.8rem;
					}

					p {
						font-size: 1.3rem;
					}

					.button {
						font-size: 1.3rem;
						padding: 0.8rem 2rem;
						width: 100%;
					}
				}
			}
		}
	}
</style>

